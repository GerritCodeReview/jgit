{
  "comments": [
    {
      "key": {
        "uuid": "3737c540_a2544c8c",
        "filename": "/COMMIT_MSG",
        "patchSetId": 1
      },
      "lineNbr": 9,
      "author": {
        "id": 9
      },
      "writtenOn": "2018-02-12T10:52:51Z",
      "side": 1,
      "message": "Could you please elaborate a bit more in the commit message about\nthis? For example:\n\n* is this change about minimizing negotiation for fetch, for push or for both?\n\n* is this change addressing the issue when JGit is used on the server side or on the client side?",
      "revId": "b999899bdb509c703eed7c2b2521e426c8dab172",
      "serverId": "97ee7c02-f12f-4043-b43e-dea463d88b31",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "a2f859c7_77569fdf",
        "filename": "/COMMIT_MSG",
        "patchSetId": 1
      },
      "lineNbr": 9,
      "author": {
        "id": 9
      },
      "writtenOn": "2018-02-12T10:52:51Z",
      "side": 1,
      "message": "rounds or refs?\n\nDo you really see \u003e100K of negotiation rounds or do you see client sending \u003e100K of .have lines?",
      "range": {
        "startLine": 9,
        "startChar": 62,
        "endLine": 9,
        "endChar": 68
      },
      "revId": "b999899bdb509c703eed7c2b2521e426c8dab172",
      "serverId": "97ee7c02-f12f-4043-b43e-dea463d88b31",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "7bcb1326_be27aaff",
        "filename": "/COMMIT_MSG",
        "patchSetId": 1
      },
      "lineNbr": 9,
      "author": {
        "id": 1628
      },
      "writtenOn": "2018-02-12T17:40:41Z",
      "side": 1,
      "message": "We have seen the client sending over 300k of have lines.",
      "parentUuid": "a2f859c7_77569fdf",
      "range": {
        "startLine": 9,
        "startChar": 62,
        "endLine": 9,
        "endChar": 68
      },
      "revId": "b999899bdb509c703eed7c2b2521e426c8dab172",
      "serverId": "97ee7c02-f12f-4043-b43e-dea463d88b31",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "edf280c9_9b180bc1",
        "filename": "/COMMIT_MSG",
        "patchSetId": 1
      },
      "lineNbr": 9,
      "author": {
        "id": 1628
      },
      "writtenOn": "2018-02-12T17:40:41Z",
      "side": 1,
      "message": "I updated the commit message with more explanation. I also found that somehow my updated test that used the new negotiation metrics in https://git.eclipse.org/r/#/c/117128 got reverted, so I restored those test updates.\n\nWe are seeing this poor negotiation behavior frequently in our JGit servers when one of our replicas falls behind and fetches content from an up-to-date server. In that case the lagging replica acts as a client, typically fetching a newly added Gerrit branch. It leads to our eventual consistency model having very poor performance, with lagging replicas consistently being \u003e10m to 1 hour behind.\n\nWithout https://git.eclipse.org/r/#/c/117128 to measure negotiation performance we don\u0027t know what percentage of client fetches are seeing this bad behavior. That said, through the use of a debugger I have seen \u003e300k have lines sent by a client. Our team that works on the Git C client knows that current negotiation is broken--it assigns no cost to the rounds of negotiation involved and does whatever it takes to generate a minimal pack file. Then plan to address this for both fetch and push in the v2 Git protocol.",
      "parentUuid": "3737c540_a2544c8c",
      "revId": "b999899bdb509c703eed7c2b2521e426c8dab172",
      "serverId": "97ee7c02-f12f-4043-b43e-dea463d88b31",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "59bbd68a_74c199d3",
        "filename": "/COMMIT_MSG",
        "patchSetId": 1
      },
      "lineNbr": 9,
      "author": {
        "id": 9
      },
      "writtenOn": "2018-02-12T23:00:47Z",
      "side": 1,
      "message": "Thanks for the explanation!\n\n\u003e We are seeing this poor negotiation behavior frequently in our JGit servers when one of our replicas falls behind and fetches content from an up-to-date server. \n\nMay I ask how do you replicate from Gerrit master to a replica?\nDo you let your replicas fetch from master instead of pushing from\nmaster to replica (like Gerrit\u0027s replication plugin does)?",
      "parentUuid": "edf280c9_9b180bc1",
      "revId": "b999899bdb509c703eed7c2b2521e426c8dab172",
      "serverId": "97ee7c02-f12f-4043-b43e-dea463d88b31",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "8c48da3d_fb0d3d7b",
        "filename": "/COMMIT_MSG",
        "patchSetId": 1
      },
      "lineNbr": 9,
      "author": {
        "id": 951
      },
      "writtenOn": "2018-02-12T23:49:15Z",
      "side": 1,
      "message": "I think https://storage.googleapis.com/gerrit-talks/summit/2015/Multimaster-Gerrit.pdf is the best resource I know of with what we\u0027ve shared about that.\n\nThe short answer is that we do a little of both (fetching and pushing).",
      "parentUuid": "59bbd68a_74c199d3",
      "revId": "b999899bdb509c703eed7c2b2521e426c8dab172",
      "serverId": "97ee7c02-f12f-4043-b43e-dea463d88b31",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "0e787e4d_a7a21609",
        "filename": "/COMMIT_MSG",
        "patchSetId": 1
      },
      "lineNbr": 9,
      "author": {
        "id": 9
      },
      "writtenOn": "2018-02-13T00:43:23Z",
      "side": 1,
      "message": "\u003e The short answer is that we do a little of both (fetching and pushing).\n\nDon\u0027t you have a similar issue, like the one addressed with this change, when pushing? We observed that the the more refs exist on the client (pushing) side the more time it takes to perform a push.",
      "parentUuid": "8c48da3d_fb0d3d7b",
      "revId": "b999899bdb509c703eed7c2b2521e426c8dab172",
      "serverId": "97ee7c02-f12f-4043-b43e-dea463d88b31",
      "unresolved": false
    }
  ]
}