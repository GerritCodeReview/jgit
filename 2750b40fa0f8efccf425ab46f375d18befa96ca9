{
  "comments": [
    {
      "key": {
        "uuid": "AABOPX//1n8\u003d",
        "filename": "org.eclipse.jgit.test/tst/org/eclipse/jgit/util/FileUtilTest.java",
        "patchSetId": 1
      },
      "lineNbr": 339,
      "author": {
        "id": 5
      },
      "writtenOn": "2013-03-24T22:56:22Z",
      "side": 1,
      "message": "This test is not working for me on Windows. That\u0027s exactly the problem which caused corrupted repo\u0027s during GC: on windows we can\u0027t rename file a to file b if b already exists. I always thought this will work on windows as long as you have correctly returned all the handles of a and b beforehand. The current rename only does a retry if on windows but this doesn\u0027t seem to be enough.\n\nShould we change FileUtils.rename() to delete the target file if the initial rename fails and then retry?",
      "revId": "2750b40fa0f8efccf425ab46f375d18befa96ca9",
      "serverId": "97ee7c02-f12f-4043-b43e-dea463d88b31",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "AABOPX//1ns\u003d",
        "filename": "org.eclipse.jgit.test/tst/org/eclipse/jgit/util/FileUtilTest.java",
        "patchSetId": 1
      },
      "lineNbr": 339,
      "author": {
        "id": 4
      },
      "writtenOn": "2013-03-25T01:32:11Z",
      "side": 1,
      "message": "wouldn\u0027t that be dangerous since this isn\u0027t atomic anymore ? What if you delete the target file and retried rename fails due to another problem ?",
      "parentUuid": "AABOPX//1n8\u003d",
      "revId": "2750b40fa0f8efccf425ab46f375d18befa96ca9",
      "serverId": "97ee7c02-f12f-4043-b43e-dea463d88b31",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "AABOPX//1lw\u003d",
        "filename": "org.eclipse.jgit.test/tst/org/eclipse/jgit/util/FileUtilTest.java",
        "patchSetId": 1
      },
      "lineNbr": 339,
      "author": {
        "id": 5
      },
      "writtenOn": "2013-03-25T08:38:50Z",
      "side": 1,
      "message": "Yes, that\u0027s the risk of such a FileUtils.rename(). FileUtils.rename() would not be atomic anymore. Robin has added a javadoc explicitly stating this when he changed the rename method in a non-atomic way in 11414.\n\nI think we will not get a atomic rename under all conditions on some platforms (e.g. Windows). What should we do if a rename fails on windows because the target file already exists?\n\nThe good think is: we will always try to do a atomic File.renameTo() first. Only if this initial attempt fails we go into a mode where we \n- retry the failing call\n- delete a empty folder hierarchy on the target location\n- delete the target file first (my suggestion)",
      "parentUuid": "AABOPX//1ns\u003d",
      "revId": "2750b40fa0f8efccf425ab46f375d18befa96ca9",
      "serverId": "97ee7c02-f12f-4043-b43e-dea463d88b31",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "AABOPX//1lc\u003d",
        "filename": "org.eclipse.jgit.test/tst/org/eclipse/jgit/util/FileUtilTest.java",
        "patchSetId": 1
      },
      "lineNbr": 339,
      "author": {
        "id": 5
      },
      "writtenOn": "2013-03-25T09:57:13Z",
      "side": 1,
      "message": "By the way: we are deleting the target in case a rename fails even in our very central LockFile class (which protects ref updates, index updates, ...). In LockFile.commit() we have this coding:\n\n\t\tif (lck.renameTo(ref))\n\t\t\treturn true;\n\t\tif (!ref.exists() || deleteRef())\n\t\t\tif (renameLock())\n\t\t\t\treturn true;\n\t\tunlock();\n\t\treturn false;\n\nIf the first rename fails and the target file exists we will call deleteRef() (which deletes the target file) and then do another rename attempt in renameLock(). Non-atomic ... but we don\u0027t have a better chance if we also want to run on windows.\n\nBy reading this I am convinced that we should do the same in FileUtils.rename()",
      "parentUuid": "AABOPX//1lw\u003d",
      "revId": "2750b40fa0f8efccf425ab46f375d18befa96ca9",
      "serverId": "97ee7c02-f12f-4043-b43e-dea463d88b31",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "AABOPX//1lQ\u003d",
        "filename": "org.eclipse.jgit.test/tst/org/eclipse/jgit/util/FileUtilTest.java",
        "patchSetId": 1
      },
      "lineNbr": 339,
      "author": {
        "id": 8
      },
      "writtenOn": "2013-03-25T10:41:54Z",
      "side": 1,
      "message": "Are you commenting on this test? This test doesn\u0027t overwrite an existing file.",
      "parentUuid": "AABOPX//1n8\u003d",
      "revId": "2750b40fa0f8efccf425ab46f375d18befa96ca9",
      "serverId": "97ee7c02-f12f-4043-b43e-dea463d88b31",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "AABOPX//1lI\u003d",
        "filename": "org.eclipse.jgit.test/tst/org/eclipse/jgit/util/FileUtilTest.java",
        "patchSetId": 1
      },
      "lineNbr": 339,
      "author": {
        "id": 8
      },
      "writtenOn": "2013-03-25T10:41:54Z",
      "side": 1,
      "message": "Atomic\u0027s gone. We need another utilty for that, if that\u0027s even possible.",
      "parentUuid": "AABOPX//1ns\u003d",
      "revId": "2750b40fa0f8efccf425ab46f375d18befa96ca9",
      "serverId": "97ee7c02-f12f-4043-b43e-dea463d88b31",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "AABOPX//1kk\u003d",
        "filename": "org.eclipse.jgit.test/tst/org/eclipse/jgit/util/FileUtilTest.java",
        "patchSetId": 1
      },
      "lineNbr": 339,
      "author": {
        "id": 4
      },
      "writtenOn": "2013-03-25T12:33:54Z",
      "side": 1,
      "message": "no, I was commenting Chris first comment here ;-)\n\ninstead of deleting the target in the second try when atomic rename has failed in the first try, we could rename the target to some unique name e.g. \u0027target.bak.\u003ctimestamp\u003e\u0027, then do the actual rename and only if that succeeds delete this bak file. This way we would at least have a backup for manual recovery if something bad happens",
      "parentUuid": "AABOPX//1lQ\u003d",
      "revId": "2750b40fa0f8efccf425ab46f375d18befa96ca9",
      "serverId": "97ee7c02-f12f-4043-b43e-dea463d88b31",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "AABOPX//1kA\u003d",
        "filename": "org.eclipse.jgit.test/tst/org/eclipse/jgit/util/FileUtilTest.java",
        "patchSetId": 1
      },
      "lineNbr": 339,
      "author": {
        "id": 5
      },
      "writtenOn": "2013-03-25T13:09:31Z",
      "side": 1,
      "message": "renaming the target to a tmp file would be safer, but costs one fs call more. In the end we have to delete the tmp file. We don\u0027t spent this effort when we e.g. update a ref or update the index. Should we do here?",
      "parentUuid": "AABOPX//1kk\u003d",
      "revId": "2750b40fa0f8efccf425ab46f375d18befa96ca9",
      "serverId": "97ee7c02-f12f-4043-b43e-dea463d88b31",
      "unresolved": false
    }
  ]
}